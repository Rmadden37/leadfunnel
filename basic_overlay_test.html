<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ground Overlay Basic Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        #map { height: 80vh; width: 100%; }
        #controls { padding: 20px; background: #f5f5f5; }
        .button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .log { margin-top: 10px; padding: 10px; background: white; border: 1px solid #ccc; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div id="controls">
        <h3>Basic Ground Overlay Test</h3>
        <button class="button" onclick="testBasicOverlay()">Test Basic Overlay</button>
        <button class="button" onclick="testSolarOverlay()">Test Solar Flux Overlay</button>
        <button class="button" onclick="clearOverlays()">Clear Overlays</button>
        <div id="log" class="log">Ready to test...</div>
    </div>
    <div id="map"></div>

    <script>
        const API_KEY = 'AIzaSyBzcUXYvRZVWAMasN93T9radVmiZVnaflk';
        let map;
        let overlays = [];

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function initMap() {
            // Davis Islands coordinates
            const davisIslands = { lat: 27.9306, lng: -82.4497 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 18,
                center: davisIslands,
                mapTypeId: 'satellite',
                tilt: 0,
                heading: 0,
                rotateControl: false
            });
            
            log("Map initialized");
        }

        function testBasicOverlay() {
            clearOverlays();
            log("Testing basic overlay with a simple image...");
            
            try {
                // Use a simple test image that we know exists
                const testImageUrl = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/talkeetna.png';
                
                const bounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(27.9296, -82.4507), // SW
                    new google.maps.LatLng(27.9316, -82.4487)  // NE
                );
                
                const overlay = new google.maps.GroundOverlay(
                    testImageUrl,
                    bounds,
                    {
                        opacity: 0.8,
                        clickable: false
                    }
                );
                
                overlay.setMap(map);
                overlays.push(overlay);
                
                log("✅ Basic overlay created - you should see a test image");
                
            } catch (error) {
                log(`❌ Basic overlay failed: ${error.message}`);
            }
        }

        async function testSolarOverlay() {
            clearOverlays();
            log("Testing solar flux overlay...");
            
            try {
                const lat = 27.9306;
                const lng = -82.4497;
                
                // Get solar data
                const url = `https://solar.googleapis.com/v1/dataLayers:get?location.latitude=${lat}&location.longitude=${lng}&radiusMeters=100&view=FULL_LAYERS&requiredQuality=HIGH&pixelSizeMeters=0.5&key=${API_KEY}`;
                
                log("Fetching solar data...");
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`Solar API response keys: ${Object.keys(data).join(', ')}`);
                
                if (data.annualFluxUrl) {
                    log(`Found flux URL: ${data.annualFluxUrl}`);
                    
                    const fluxUrlWithKey = `${data.annualFluxUrl}&key=${API_KEY}`;
                    log(`Testing flux URL with key...`);
                    
                    // Test URL accessibility
                    const testResponse = await fetch(fluxUrlWithKey, { method: 'HEAD' });
                    log(`Flux URL test: ${testResponse.status} ${testResponse.statusText}`);
                    
                    if (testResponse.ok) {
                        log(`✅ Flux URL is accessible`);
                        
                        // Create bounds
                        const bounds = data.dsmBounds || data.imageryBounds;
                        if (bounds) {
                            log(`Using bounds: SW(${bounds.sw.latitude}, ${bounds.sw.longitude}) NE(${bounds.ne.latitude}, ${bounds.ne.longitude})`);
                            
                            const mapBounds = new google.maps.LatLngBounds(
                                new google.maps.LatLng(bounds.sw.latitude, bounds.sw.longitude),
                                new google.maps.LatLng(bounds.ne.latitude, bounds.ne.longitude)
                            );
                            
                            // Create overlay
                            const overlay = new google.maps.GroundOverlay(
                                fluxUrlWithKey,
                                mapBounds,
                                {
                                    opacity: 0.7,
                                    clickable: false
                                }
                            );
                            
                            overlay.setMap(map);
                            overlays.push(overlay);
                            
                            log("✅ Solar flux overlay created!");
                            
                            // Fit map to bounds
                            map.fitBounds(mapBounds);
                            
                        } else {
                            log("❌ No bounds found in solar data");
                        }
                        
                    } else {
                        log(`❌ Flux URL not accessible: ${testResponse.status}`);
                    }
                    
                } else {
                    log("❌ No annualFluxUrl in response");
                    log(`Available keys: ${Object.keys(data).join(', ')}`);
                }
                
            } catch (error) {
                log(`❌ Solar overlay failed: ${error.message}`);
            }
        }

        function clearOverlays() {
            overlays.forEach(overlay => overlay.setMap(null));
            overlays = [];
            log("Overlays cleared");
        }

        // Make initMap available globally
        window.initMap = initMap;
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzcUXYvRZVWAMasN93T9radVmiZVnaflk&callback=initMap">
    </script>
</body>
</html>
