<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Solar Flux Heatmap</title>
    <script src="https://cdn.jsdelivr.net/npm/geotiff@2.0.7/dist-browser/geotiff.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .status { margin: 10px 0; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Solar Flux Heatmap Debug Tool</h1>
    
    <div class="debug-section">
        <h3>Step 1: Test Davis Islands Solar API Data Layers</h3>
        <button onclick="testDataLayers()">Test Data Layers API</button>
        <div id="dataLayersStatus" class="status"></div>
        <div id="dataLayersLog" class="log"></div>
    </div>
    
    <div class="debug-section">
        <h3>Step 2: Test Flux URL Access</h3>
        <button onclick="testFluxUrl()" id="testFluxBtn" disabled>Test Flux URL</button>
        <div id="fluxUrlStatus" class="status"></div>
        <div id="fluxUrlLog" class="log"></div>
    </div>
    
    <div class="debug-section">
        <h3>Step 3: Test GeoTIFF Loading</h3>
        <button onclick="testGeoTIFF()" id="testGeoTIFFBtn" disabled>Test GeoTIFF Loading</button>
        <div id="geoTiffStatus" class="status"></div>
        <div id="geoTiffLog" class="log"></div>
    </div>

    <script>
        const API_KEY = 'AIzaSyBzcUXYvRZVWAMasN93T9radVmiZVnaflk';
        
        // Davis Islands coordinates
        const LAT = 27.9306;
        const LNG = -82.4497;
        
        let currentFluxUrl = null;
        let currentBounds = null;

        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            container.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        function setStatus(statusId, message, type = 'info') {
            const status = document.getElementById(statusId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            status.innerHTML = `<span class="${className}">${message}</span>`;
        }

        async function testDataLayers() {
            log('dataLayersLog', 'Starting Data Layers API test...');
            setStatus('dataLayersStatus', 'Testing...');
            
            try {
                const url = `https://solar.googleapis.com/v1/dataLayers:get?location.latitude=${LAT}&location.longitude=${LNG}&radiusMeters=100&view=FULL_LAYERS&requiredQuality=HIGH&pixelSizeMeters=0.5&key=${API_KEY}`;
                
                log('dataLayersLog', `Request URL: ${url}`);
                
                const response = await fetch(url);
                log('dataLayersLog', `Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log('dataLayersLog', `Response received with keys: ${Object.keys(data).join(', ')}`);
                
                // Check for annual flux URL
                if (data.annualFluxUrl) {
                    currentFluxUrl = data.annualFluxUrl;
                    log('dataLayersLog', `✓ Annual flux URL found: ${currentFluxUrl}`, 'success');
                } else {
                    log('dataLayersLog', '✗ No annualFluxUrl in response', 'warning');
                }
                
                // Check for bounds
                if (data.rgbUrl && data.dsmBounds) {
                    currentBounds = data.dsmBounds;
                    log('dataLayersLog', `✓ Bounds found: SW(${data.dsmBounds.sw.latitude}, ${data.dsmBounds.sw.longitude}) NE(${data.dsmBounds.ne.latitude}, ${data.dsmBounds.ne.longitude})`, 'success');
                } else {
                    log('dataLayersLog', '✗ No bounds found in response', 'warning');
                }
                
                log('dataLayersLog', `Full response: ${JSON.stringify(data, null, 2)}`);
                
                if (currentFluxUrl && currentBounds) {
                    setStatus('dataLayersStatus', 'Success - Flux URL and bounds found', 'success');
                    document.getElementById('testFluxBtn').disabled = false;
                } else {
                    setStatus('dataLayersStatus', 'Partial success - Missing flux URL or bounds', 'warning');
                }
                
            } catch (error) {
                log('dataLayersLog', `Error: ${error.message}`, 'error');
                setStatus('dataLayersStatus', `Error: ${error.message}`, 'error');
            }
        }

        async function testFluxUrl() {
            if (!currentFluxUrl) {
                log('fluxUrlLog', 'No flux URL available from previous test', 'error');
                return;
            }
            
            log('fluxUrlLog', 'Testing flux URL access...');
            setStatus('fluxUrlStatus', 'Testing...');
            
            try {
                // Add API key to flux URL
                const urlWithKey = `${currentFluxUrl}&key=${API_KEY}`;
                log('fluxUrlLog', `Testing URL: ${urlWithKey}`);
                
                const response = await fetch(urlWithKey, { method: 'HEAD' });
                log('fluxUrlLog', `HEAD response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    const contentLength = response.headers.get('content-length');
                    log('fluxUrlLog', `✓ URL accessible`, 'success');
                    log('fluxUrlLog', `Content-Type: ${contentType}`);
                    log('fluxUrlLog', `Content-Length: ${contentLength} bytes`);
                    
                    setStatus('fluxUrlStatus', 'Success - URL accessible', 'success');
                    document.getElementById('testGeoTIFFBtn').disabled = false;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                log('fluxUrlLog', `Error accessing URL: ${error.message}`, 'error');
                setStatus('fluxUrlStatus', `Error: ${error.message}`, 'error');
            }
        }

        async function testGeoTIFF() {
            if (!currentFluxUrl) {
                log('geoTiffLog', 'No flux URL available', 'error');
                return;
            }
            
            log('geoTiffLog', 'Testing GeoTIFF loading with geotiff.js...');
            setStatus('geoTiffStatus', 'Testing...');
            
            try {
                const urlWithKey = `${currentFluxUrl}&key=${API_KEY}`;
                log('geoTiffLog', `Loading GeoTIFF from: ${urlWithKey}`);
                
                const tiff = await GeoTIFF.fromUrl(urlWithKey);
                log('geoTiffLog', '✓ GeoTIFF loaded successfully', 'success');
                
                const image = await tiff.getImage();
                const width = image.getWidth();
                const height = image.getHeight();
                log('geoTiffLog', `✓ Image dimensions: ${width} x ${height}`, 'success');
                
                const rasters = await image.readRasters({ interleave: false, samples: [0] });
                const data = rasters[0];
                log('geoTiffLog', `✓ Raster data loaded: ${data.length} pixels`, 'success');
                
                // Analyze data
                let minVal = Infinity;
                let maxVal = -Infinity;
                let validPixels = 0;
                let zeroPixels = 0;
                
                for (let i = 0; i < data.length; i++) {
                    const val = data[i];
                    if (val > 0) {
                        minVal = Math.min(minVal, val);
                        maxVal = Math.max(maxVal, val);
                        validPixels++;
                    } else if (val === 0) {
                        zeroPixels++;
                    }
                }
                
                log('geoTiffLog', `Data analysis:`, 'success');
                log('geoTiffLog', `  - Valid pixels (>0): ${validPixels}`, 'success');
                log('geoTiffLog', `  - Zero pixels: ${zeroPixels}`, 'success');
                log('geoTiffLog', `  - Min value: ${minVal}`, 'success');
                log('geoTiffLog', `  - Max value: ${maxVal}`, 'success');
                
                if (validPixels > 0) {
                    setStatus('geoTiffStatus', `Success - GeoTIFF loaded with ${validPixels} valid pixels`, 'success');
                } else {
                    setStatus('geoTiffStatus', 'Warning - GeoTIFF loaded but no valid flux data', 'warning');
                }
                
            } catch (error) {
                log('geoTiffLog', `Error loading GeoTIFF: ${error.message}`, 'error');
                setStatus('geoTiffStatus', `Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
