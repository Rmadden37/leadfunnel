<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ground Overlay Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        #map { height: 70vh; width: 100%; }
        #controls { padding: 20px; background: #f5f5f5; }
        .log { margin-top: 10px; padding: 10px; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div id="controls">
        <h3>Ground Overlay Test (Direct GeoTIFF URL)</h3>
        <button onclick="testGroundOverlay()">Test Ground Overlay</button>
        <button onclick="clearOverlay()">Clear Overlay</button>
        <div id="log" class="log">Ready to test...</div>
    </div>
    <div id="map"></div>

    <script>
        const API_KEY = 'AIzaSyBzcUXYvRZVWAMasN93T9radVmiZVnaflk';
        let map;
        let currentOverlay = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Initialize Google Maps
        function initMap() {
            // Davis Islands coordinates
            const davisIslands = { lat: 27.9306, lng: -82.4497 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 18,
                center: davisIslands,
                mapTypeId: 'satellite'
            });
            
            log("Map initialized");
        }

        async function testGroundOverlay() {
            if (!map) {
                log("Map not initialized");
                return;
            }
            
            clearOverlay();
            
            try {
                log("Getting Solar API data...");
                
                const lat = 27.9306;
                const lng = -82.4497;
                const url = `https://solar.googleapis.com/v1/dataLayers:get?location.latitude=${lat}&location.longitude=${lng}&radiusMeters=100&view=FULL_LAYERS&requiredQuality=HIGH&pixelSizeMeters=0.5&key=${API_KEY}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log("Solar API response received");
                log(`Response keys: ${Object.keys(data).join(', ')}`);
                
                let fluxUrl = data.annualFluxUrl;
                let bounds = data.dsmBounds;
                
                if (!fluxUrl) {
                    log("No annualFluxUrl found");
                    // Let's try any URL that might be a GeoTIFF
                    const urlKeys = Object.keys(data).filter(key => key.toLowerCase().includes('url'));
                    log(`Available URL keys: ${urlKeys.join(', ')}`);
                    return;
                }
                
                if (!bounds) {
                    log("No bounds found, creating default bounds");
                    bounds = {
                        sw: { latitude: lat - 0.001, longitude: lng - 0.001 },
                        ne: { latitude: lat + 0.001, longitude: lng + 0.001 }
                    };
                }
                
                log(`Flux URL: ${fluxUrl}`);
                log(`Bounds: SW(${bounds.sw.latitude}, ${bounds.sw.longitude}) NE(${bounds.ne.latitude}, ${bounds.ne.longitude})`);
                
                const urlWithKey = `${fluxUrl}&key=${API_KEY}`;
                
                const mapBounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(bounds.sw.latitude, bounds.sw.longitude),
                    new google.maps.LatLng(bounds.ne.latitude, bounds.ne.longitude)
                );
                
                // Try using Google Maps GroundOverlay directly
                log("Creating GroundOverlay with GeoTIFF URL...");
                currentOverlay = new google.maps.GroundOverlay(
                    urlWithKey,
                    mapBounds,
                    {
                        opacity: 0.6,
                        clickable: false
                    }
                );
                
                currentOverlay.setMap(map);
                log("GroundOverlay created and added to map");
                
                // Add listeners for debugging
                currentOverlay.addListener('click', () => {
                    log("Overlay clicked");
                });
                
                // Check if the overlay loaded
                setTimeout(() => {
                    log("Checking overlay status...");
                }, 3000);
                
            } catch (error) {
                log(`Error: ${error.message}`);
            }
        }

        function clearOverlay() {
            if (currentOverlay) {
                currentOverlay.setMap(null);
                currentOverlay = null;
                log("Overlay cleared");
            }
        }

        // Make initMap available globally
        window.initMap = initMap;
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzcUXYvRZVWAMasN93T9radVmiZVnaflk&callback=initMap">
    </script>
</body>
</html>
