<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Flux Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .panel { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        #map { height: 400px; width: 100%; border-radius: 8px; }
        .button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #45a049; }
        .button.secondary { background: #2196F3; }
        .button.warning { background: #ff9800; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; border-left: 4px solid #007bff; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .overlay-info { background: #e7f3ff; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Complete Solar Flux Overlay Debug</h1>
        <p>Comprehensive testing of Solar API flux data and Google Maps overlays</p>
        
        <div class="two-column">
            <div class="panel">
                <h3>üó∫Ô∏è Map Test Area</h3>
                <div id="map"></div>
                <div style="margin-top: 15px;">
                    <button class="button" onclick="testBasicOverlay()">üé® Test Basic Overlay</button>
                    <button class="button secondary" onclick="testSolarFlux()">‚òÄÔ∏è Test Solar Flux</button>
                    <button class="button warning" onclick="clearAllOverlays()">üóëÔ∏è Clear All</button>
                </div>
                <div id="overlayStatus" class="overlay-info" style="display: none;">
                    <strong>Overlay Status:</strong> <span id="overlayStatusText">None</span>
                </div>
            </div>
            
            <div class="panel">
                <h3>üìã Test Results</h3>
                <div class="status" id="testStatus" style="display: none;"></div>
                <div id="testLog" class="log">Ready to run tests...</div>
            </div>
        </div>
        
        <div class="panel">
            <h3>üè† Address Testing</h3>
            <div style="margin-bottom: 15px;">
                <input type="text" id="addressInput" placeholder="Enter address to test..." style="width: 400px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                <button class="button" onclick="testAddress()">üîç Test Address</button>
            </div>
            <div class="two-column">
                <div>
                    <h4>Quick Test Locations:</h4>
                    <button class="button secondary" onclick="testLocation(37.4419, -122.1430, 'Palo Alto, CA (Google HQ)')">Palo Alto, CA</button>
                    <button class="button secondary" onclick="testLocation(40.7589, -73.9851, 'New York, NY')">New York, NY</button>
                    <button class="button secondary" onclick="testLocation(27.9306, -82.4497, 'Davis Islands, Tampa, FL')">Davis Islands, FL</button>
                    <button class="button secondary" onclick="testLocation(25.7617, -80.1918, 'Miami, FL')">Miami, FL</button>
                </div>
                <div id="locationResults">
                    <p><em>Select a location to see API test results</em></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyBzcUXYvRZVWAMasN93T9radVmiZVnaflk';
        let map;
        let overlays = [];
        let currentFluxData = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('testStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function setOverlayStatus(text, active = false) {
            const statusDiv = document.getElementById('overlayStatus');
            const textSpan = document.getElementById('overlayStatusText');
            textSpan.textContent = text;
            statusDiv.style.display = 'block';
            statusDiv.style.background = active ? '#d4edda' : '#e7f3ff';
        }

        function initMap() {
            log("Initializing Google Maps...");
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 18,
                center: { lat: 27.9306, lng: -82.4497 }, // Davis Islands
                mapTypeId: 'satellite',
                tilt: 0,
                heading: 0,
                rotateControl: false,
                gestureHandling: 'greedy'
            });
            
            log("‚úÖ Map initialized successfully", 'success');
            setOverlayStatus("Map ready");
        }

        function clearAllOverlays() {
            overlays.forEach(overlay => {
                if (overlay && overlay.setMap) {
                    overlay.setMap(null);
                }
            });
            overlays = [];
            setOverlayStatus("None");
            log("üóëÔ∏è All overlays cleared");
        }

        function testBasicOverlay() {
            clearAllOverlays();
            log("Testing basic Google Maps GroundOverlay...");
            setStatus("Testing basic overlay...", 'warning');
            
            try {
                // Use Google's own test image
                const testImageUrl = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/talkeetna.png';
                
                const bounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(27.9296, -82.4507), // SW
                    new google.maps.LatLng(27.9316, -82.4487)  // NE
                );
                
                const overlay = new google.maps.GroundOverlay(
                    testImageUrl,
                    bounds,
                    {
                        opacity: 0.8,
                        clickable: false
                    }
                );
                
                overlay.setMap(map);
                overlays.push(overlay);
                
                log("‚úÖ Basic GroundOverlay created successfully!", 'success');
                setStatus("‚úÖ Basic overlay working correctly", 'success');
                setOverlayStatus("Basic test image active", true);
                
                // Fit map to overlay bounds
                map.fitBounds(bounds);
                
            } catch (error) {
                log(`‚ùå Basic overlay failed: ${error.message}`, 'error');
                setStatus("‚ùå Basic overlay failed - Google Maps issue", 'error');
            }
        }

        async function testSolarFlux() {
            clearAllOverlays();
            log("Testing Solar API flux overlay...");
            setStatus("Testing solar flux overlay...", 'warning');
            
            try {
                if (!currentFluxData) {
                    log("No flux data available - run a location test first", 'warning');
                    setStatus("‚ùå No flux data - test a location first", 'error');
                    return;
                }
                
                log(`Using flux URL: ${currentFluxData.fluxUrl}`);
                log(`Using bounds: SW(${currentFluxData.bounds.sw.latitude}, ${currentFluxData.bounds.sw.longitude})`);
                
                const mapBounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(currentFluxData.bounds.sw.latitude, currentFluxData.bounds.sw.longitude),
                    new google.maps.LatLng(currentFluxData.bounds.ne.latitude, currentFluxData.bounds.ne.longitude)
                );
                
                // Ensure 2D mode
                map.setTilt(0);
                map.setHeading(0);
                
                const overlay = new google.maps.GroundOverlay(
                    currentFluxData.fluxUrl,
                    mapBounds,
                    {
                        opacity: 0.8,
                        clickable: false
                    }
                );
                
                overlay.setMap(map);
                overlays.push(overlay);
                
                log("‚úÖ Solar flux overlay created!", 'success');
                setStatus("‚úÖ Solar flux overlay active", 'success');
                setOverlayStatus("Solar flux heatmap active", true);
                
                // Fit map to overlay bounds
                map.fitBounds(mapBounds);
                
            } catch (error) {
                log(`‚ùå Solar flux overlay failed: ${error.message}`, 'error');
                setStatus("‚ùå Solar flux overlay failed", 'error');
            }
        }

        async function testLocation(lat, lng, name) {
            log(`\nüè† Testing location: ${name} (${lat}, ${lng})`);
            setStatus(`Testing ${name}...`, 'warning');
            
            const resultsDiv = document.getElementById('locationResults');
            resultsDiv.innerHTML = `<h5>Testing: ${name}</h5><div id="locationLog">Testing...</div>`;
            const locationLog = document.getElementById('locationLog');
            
            function logLocation(message, type = 'info') {
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
                locationLog.innerHTML += `<div class="${className}">${message}</div>`;
                log(message, type);
            }
            
            try {
                // Test Solar API Data Layers
                const dataUrl = `https://solar.googleapis.com/v1/dataLayers:get?location.latitude=${lat}&location.longitude=${lng}&radiusMeters=100&view=FULL_LAYERS&requiredQuality=HIGH&pixelSizeMeters=0.5&key=${API_KEY}`;
                
                logLocation("Fetching Solar API data layers...");
                const response = await fetch(dataUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    const keys = Object.keys(data);
                    logLocation(`‚úÖ API Response keys: ${keys.join(', ')}`, 'success');
                    
                    // Check for flux URL
                    if (data.annualFluxUrl) {
                        logLocation(`‚úÖ Found annualFluxUrl!`, 'success');
                        
                        // Test URL accessibility
                        const fluxUrlWithKey = `${data.annualFluxUrl}&key=${API_KEY}`;
                        const urlTest = await fetch(fluxUrlWithKey, { method: 'HEAD' });
                        
                        if (urlTest.ok) {
                            logLocation(`‚úÖ Flux URL accessible (${urlTest.status})`, 'success');
                            logLocation(`Content-Type: ${urlTest.headers.get('content-type')}`);
                            
                            // Store flux data for overlay testing
                            if (data.dsmBounds || data.imageryBounds) {
                                const bounds = data.dsmBounds || data.imageryBounds;
                                currentFluxData = {
                                    fluxUrl: fluxUrlWithKey,
                                    bounds: bounds,
                                    location: { lat, lng }
                                };
                                
                                logLocation(`‚úÖ Bounds available: SW(${bounds.sw.latitude}, ${bounds.sw.longitude})`, 'success');
                                logLocation(`üéØ Ready for flux overlay test!`, 'success');
                                
                                setStatus(`‚úÖ ${name} has flux data available!`, 'success');
                                
                                // Center map on this location
                                map.setCenter({ lat, lng });
                                map.setZoom(19);
                                
                            } else {
                                logLocation(`‚ö†Ô∏è No bounds found`, 'warning');
                            }
                            
                        } else {
                            logLocation(`‚ùå Flux URL not accessible (${urlTest.status})`, 'error');
                        }
                        
                    } else {
                        logLocation(`‚ùå No annualFluxUrl found`, 'warning');
                        
                        // Check for any flux-related keys
                        const fluxKeys = keys.filter(k => k.toLowerCase().includes('flux'));
                        if (fluxKeys.length > 0) {
                            logLocation(`Found other flux keys: ${fluxKeys.join(', ')}`, 'warning');
                        } else {
                            logLocation(`No flux-related data available`, 'warning');
                        }
                    }
                    
                } else {
                    const errorText = await response.text();
                    logLocation(`‚ùå API Error: ${response.status} - ${errorText}`, 'error');
                    setStatus(`‚ùå ${name} - API Error ${response.status}`, 'error');
                }
                
            } catch (error) {
                logLocation(`‚ùå Error: ${error.message}`, 'error');
                setStatus(`‚ùå ${name} - Test Error`, 'error');
            }
        }

        async function testAddress() {
            const addressInput = document.getElementById('addressInput');
            const address = addressInput.value.trim();
            
            if (!address) {
                alert('Please enter an address');
                return;
            }
            
            log(`\nüîç Geocoding address: ${address}`);
            setStatus('Geocoding address...', 'warning');
            
            try {
                const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${API_KEY}`;
                const response = await fetch(geocodeUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'OK' && data.results.length > 0) {
                        const location = data.results[0].geometry.location;
                        const formattedAddress = data.results[0].formatted_address;
                        
                        log(`‚úÖ Geocoded to: ${location.lat}, ${location.lng}`, 'success');
                        await testLocation(location.lat, location.lng, formattedAddress);
                        
                    } else {
                        log(`‚ùå Geocoding failed: ${data.status}`, 'error');
                        setStatus('‚ùå Address not found', 'error');
                    }
                } else {
                    log(`‚ùå Geocoding API error: ${response.status}`, 'error');
                    setStatus('‚ùå Geocoding API error', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Geocoding error: ${error.message}`, 'error');
                setStatus('‚ùå Geocoding error', 'error');
            }
        }

        // Make initMap available globally
        window.initMap = initMap;
        
        // Initialize with default address
        window.onload = function() {
            document.getElementById('addressInput').value = 'Davis Islands, Tampa, FL';
        };
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzcUXYvRZVWAMasN93T9radVmiZVnaflk&callback=initMap">
    </script>
</body>
</html>
