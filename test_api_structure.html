<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar API Structure Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .json { background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
        .button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #45a049; }
        .button:disabled { background: #cccccc; cursor: not-allowed; }
        .status { margin: 10px 0; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Solar API Structure Test</h1>
    <p>This tool will test both the Solar Insights API and Data Layers API to understand the exact structure of responses.</p>
    
    <div class="section">
        <h3>1. Test Solar Insights API</h3>
        <button class="button" onclick="testSolarInsights()">Test Solar Insights</button>
        <div id="insightsStatus" class="status"></div>
        <div id="insightsResponse" class="json"></div>
    </div>
    
    <div class="section">
        <h3>2. Test Data Layers API</h3>
        <button class="button" onclick="testDataLayers()">Test Data Layers</button>
        <div id="dataLayersStatus" class="status"></div>
        <div id="dataLayersResponse" class="json"></div>
    </div>
    
    <div class="section">
        <h3>3. Test Different Locations</h3>
        <input type="text" id="addressInput" placeholder="Enter address to test" style="width: 300px; padding: 8px; margin-right: 10px;">
        <button class="button" onclick="testCustomLocation()">Test Location</button>
        <div id="customLocationStatus" class="status"></div>
        <div id="customLocationResponse" class="json"></div>
    </div>

    <script>
        const API_KEY = 'AIzaSyBzcUXYvRZVWAMasN93T9radVmiZVnaflk';
        
        // Default to Davis Islands, Tampa
        let currentLat = 27.9306;
        let currentLng = -82.4497;

        function setStatus(id, message, type = 'info') {
            const element = document.getElementById(id);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        function setResponse(id, data) {
            const element = document.getElementById(id);
            element.textContent = JSON.stringify(data, null, 2);
        }

        async function testSolarInsights() {
            setStatus('insightsStatus', 'Testing Solar Insights API...', 'info');
            setResponse('insightsResponse', {});
            
            try {
                const url = `https://solar.googleapis.com/v1/buildingInsights:findClosest?location.latitude=${currentLat}&location.longitude=${currentLng}&requiredQuality=HIGH&key=${API_KEY}`;
                
                console.log('Solar Insights URL:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                setStatus('insightsStatus', 'Success!', 'success');
                setResponse('insightsResponse', data);
                
                // Extract key information
                console.log('Solar Insights Response:', data);
                if (data.solarPotential) {
                    console.log('Solar potential found:', Object.keys(data.solarPotential));
                }
                
            } catch (error) {
                setStatus('insightsStatus', `Error: ${error.message}`, 'error');
                setResponse('insightsResponse', { error: error.message });
            }
        }

        async function testDataLayers() {
            setStatus('dataLayersStatus', 'Testing Data Layers API...', 'info');
            setResponse('dataLayersResponse', {});
            
            try {
                const url = `https://solar.googleapis.com/v1/dataLayers:get?location.latitude=${currentLat}&location.longitude=${currentLng}&radiusMeters=100&view=FULL_LAYERS&requiredQuality=HIGH&pixelSizeMeters=0.5&key=${API_KEY}`;
                
                console.log('Data Layers URL:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                setStatus('dataLayersStatus', 'Success!', 'success');
                setResponse('dataLayersResponse', data);
                
                // Extract key information
                console.log('Data Layers Response:', data);
                console.log('Available keys:', Object.keys(data));
                
                // Check for flux URLs
                const fluxKeys = Object.keys(data).filter(key => key.toLowerCase().includes('flux'));
                console.log('Flux-related keys:', fluxKeys);
                
                // Check for URL fields
                const urlKeys = Object.keys(data).filter(key => key.toLowerCase().includes('url'));
                console.log('URL-related keys:', urlKeys);
                
                // Check for bounds
                const boundsKeys = Object.keys(data).filter(key => key.toLowerCase().includes('bound'));
                console.log('Bounds-related keys:', boundsKeys);
                
            } catch (error) {
                setStatus('dataLayersStatus', `Error: ${error.message}`, 'error');
                setResponse('dataLayersResponse', { error: error.message });
            }
        }

        async function testCustomLocation() {
            const addressInput = document.getElementById('addressInput');
            const address = addressInput.value.trim();
            
            if (!address) {
                alert('Please enter an address');
                return;
            }
            
            setStatus('customLocationStatus', 'Geocoding address...', 'info');
            setResponse('customLocationResponse', {});
            
            try {
                // First geocode the address
                const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${API_KEY}`;
                
                const geocodeResponse = await fetch(geocodeUrl);
                if (!geocodeResponse.ok) {
                    throw new Error(`Geocoding failed: ${geocodeResponse.status}`);
                }
                
                const geocodeData = await geocodeResponse.json();
                if (geocodeData.status !== 'OK' || !geocodeData.results.length) {
                    throw new Error(`No results found for address: ${address}`);
                }
                
                const location = geocodeData.results[0].geometry.location;
                currentLat = location.lat;
                currentLng = location.lng;
                
                setStatus('customLocationStatus', `Geocoded to ${currentLat}, ${currentLng}. Testing Solar API...`, 'info');
                
                // Test both APIs
                await testSolarInsights();
                await testDataLayers();
                
                setStatus('customLocationStatus', 'Custom location test completed!', 'success');
                
            } catch (error) {
                setStatus('customLocationStatus', `Error: ${error.message}`, 'error');
                setResponse('customLocationResponse', { error: error.message });
            }
        }

        // Initialize with Davis Islands test
        window.onload = function() {
            document.getElementById('addressInput').value = 'Davis Islands, Tampa, FL';
        };
    </script>
</body>
</html>
